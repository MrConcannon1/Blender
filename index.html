<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blender Fundamentals: Basics & Shortcuts</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for the terminal theme */
        :root {
            --terminal-bg: #1e1e1e;
            --terminal-text: #00ff00;
            --terminal-accent: #00cc00;
            --terminal-error: #ff5555;
            --terminal-info: #55aaff;
        }

        body {
            font-family: 'Consolas', 'Courier New', monospace;
            background-color: #0d0d0d;
            color: var(--terminal-text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .terminal-container {
            width: 100%;
            max-width: 900px;
            background-color: var(--terminal-bg);
            box-shadow: 0 0 20px var(--terminal-accent);
            border: 2px solid var(--terminal-accent);
        }

        .terminal-header {
            background-color: #000;
            color: #fff;
            padding: 0.5rem 1rem;
            border-bottom: 2px solid var(--terminal-accent);
        }

        .code-input {
            background-color: #2c2c2c;
            color: var(--terminal-text);
            border: 1px solid var(--terminal-accent);
            transition: all 0.2s;
        }

        .code-input:focus {
            outline: none;
            box-shadow: 0 0 5px var(--terminal-accent);
        }

        .draggable-item {
            cursor: grab;
            border: 1px solid var(--terminal-accent);
            background-color: #333;
            color: var(--terminal-text);
            transition: all 0.2s;
        }

        .draggable-item:active {
            cursor: grabbing;
            box-shadow: 0 0 10px var(--terminal-text);
        }

        .drop-target {
            min-height: 48px;
            border: 2px dashed var(--terminal-accent);
            background-color: #222;
        }

        .correct {
            border-color: #00cc00 !important;
            box-shadow: 0 0 10px #00cc00;
        }
        .incorrect {
            border-color: var(--terminal-error) !important;
            box-shadow: 0 0 10px var(--terminal-error);
        }

        /* Utility for glowing text/borders */
        .glow-text {
            text-shadow: 0 0 5px var(--terminal-text);
        }
        .glow-border {
            box-shadow: 0 0 8px var(--terminal-accent);
        }
        
    </style>
</head>
<body>

<div id="game-container" class="terminal-container rounded-lg overflow-hidden">
    <div class="terminal-header flex justify-between items-center text-sm">
        <span class="font-bold">[[ SYSTEM_ACCESS: BLENDER SHORTCUT QUIZ ]]</span>
        <span id="score-display" class="glow-text text-lg">SCORE: 0</span>
    </div>

    <div class="p-6 space-y-6">
        <!-- Progress Bar & Indicator -->
        <div class="flex items-center text-xs">
            <div id="progress-bar-container" class="flex-grow h-2 bg-gray-700 rounded-full mr-4">
                <div id="progress-bar" class="h-2 bg-green-500 rounded-full transition-all duration-500"></div>
            </div>
            <span id="progress-text" class="text-green-400">Loading Module...</span>
        </div>

        <!-- Lesson Introduction/Recap Area -->
        <div id="recap-section" class="bg-gray-800 p-4 rounded-lg border-l-4 border-yellow-500 hidden">
            <h2 id="recap-title" class="text-xl font-bold text-yellow-300 mb-2"></h2>
            <p id="recap-content" class="text-sm text-gray-300 whitespace-pre-wrap leading-relaxed"></p>
            <button id="start-level-btn" onclick="startLevel()" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-500 transition-colors">
                Start Quiz <i class="fas fa-play ml-2"></i>
            </button>
        </div>

        <!-- Question Area -->
        <div id="question-area" class="space-y-4 hidden">
            <div class="flex justify-between items-start border-b border-gray-700 pb-2">
                <h3 id="question-title" class="text-xl font-bold text-green-400"></h3>
                <span id="attainment-tag" class="text-xs font-semibold px-2 py-1 rounded-full border border-gray-600"></span>
            </div>
            
            <pre id="question-code-snippet" class="bg-black p-4 rounded-lg overflow-x-auto text-sm text-yellow-300"></pre>
            
            <div id="task-renderer" class="bg-gray-900 p-4 rounded-lg min-h-[150px]">
                <!-- Task-specific content renders here (MCQ, Code Input, Drag/Drop) -->
            </div>

            <button id="submit-btn" onclick="handleSubmit()" class="w-full px-6 py-3 bg-cyan-700 text-white rounded-md hover:bg-cyan-600 transition-colors font-bold glow-border">
                [SUBMIT SOLUTION]
            </button>
        </div>
        
        <!-- Game Over Message -->
        <div id="game-over-area" class="text-center p-8 hidden">
            <h2 class="text-4xl font-extrabold text-green-400 glow-text mb-4">BLENDER QUIZ COMPLETE</h2>
            <p class="text-xl mb-6">Final Score: <span id="final-score" class="font-bold text-yellow-300"></span></p>
            <p class="text-gray-400">You have successfully tested your knowledge of Blender basics and shortcuts.</p>
            <p class="text-gray-500 text-sm mt-4">System shutting down...</p>
        </div>
    </div>
</div>

<!-- Modal for Feedback/Error Messages -->
<div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden">
    <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full border-2" id="modal-content-card">
        <h3 id="modal-title" class="text-2xl font-bold mb-3"></h3>
        <p id="modal-message" class="mb-4 text-sm whitespace-pre-wrap"></p>
        <p id="modal-mini-lesson" class="text-xs italic p-3 bg-gray-900 rounded-md mb-4 text-green-300 border-l-4 border-green-500 hidden"></p>
        <button id="modal-close-btn" onclick="closeModal()" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-500 transition-colors font-semibold">
            <span id="modal-btn-text">Proceed</span> <i class="fas fa-arrow-right ml-2"></i>
        </button>
    </div>
</div>

<script>
    // --------------------------------------------------------------------------------
    // 1. DYNAMIC CONTENT & ATTAINMENT FOCUS (Blender Shortcuts Focus)
    // --------------------------------------------------------------------------------
    const LESSON_DATA = [
        // --- LEVEL 1: NAVIGATION & VIEW (Essential Keys) ---
        {
            level: 1,
            title: "Level 1: Navigation & View Shortcuts",
            recap: `FOCUS: Essential keyboard shortcuts for navigating the 3D Viewport and switching between modeling modes.

Key Shortcuts to Master:
- View control (Orbit, Pan, Zoom)
- Mode switching (Object vs. Edit)
- Adding new geometry.`,
            questions: [
                {
                    id: "B1Q1",
                    attainment: "Low",
                    mpa: 100,
                    type: "MCQ",
                    prompt: "Which key is the universal shortcut to switch between Object Mode and Edit Mode?",
                    code: "// Switching to modify vertices/faces...",
                    options: [
                        { text: "E (Extrude)", isCorrect: false },
                        { text: "Tab", isCorrect: true },
                        { text: "A (Select All)", isCorrect: false },
                        { text: "Z (Shading Pie Menu)", isCorrect: false }
                    ],
                    feedback_incorrect: "The 'Tab' key is the quickest way to toggle between Object Mode (manipulating whole objects) and Edit Mode (manipulating mesh components).",
                    mini_lesson: "Mini-Lesson: Use 'Tab' before starting any detailed modeling work."
                },
                {
                    id: "B1Q2",
                    attainment: "Medium",
                    mpa: 150,
                    type: "CODE_INPUT",
                    prompt: "Enter the single key shortcut used to activate the **Grab/Move** transformation tool.",
                    code: "// I need to reposition the selected object...",
                    answer: "G",
                    feedback_incorrect: "The shortcut is 'G', short for Grab.",
                    mini_lesson: "Mini-Lesson: G (Grab), R (Rotate), S (Scale) are the core transformation keys."
                },
                {
                    id: "B1Q3",
                    attainment: "High",
                    mpa: 200,
                    type: "MCQ",
                    prompt: "Which key combination opens the **Add Menu** (Mesh, Light, Camera) to insert new objects?",
                    code: "// Adding a new cylinder to the scene...",
                    options: [
                        { text: "Ctrl + A", isCorrect: false },
                        { text: "Shift + A", isCorrect: true },
                        { text: "Alt + A", isCorrect: false },
                        { text: "Ctrl + S", isCorrect: false }
                    ],
                    feedback_incorrect: "Shift + A opens the 'Add' menu, the primary way to insert geometry and lights.",
                    mini_lesson: "Mini-Lesson: Shift + A (Add) is one of the most essential shortcuts."
                },
                {
                    id: "B1Q4",
                    attainment: "Medium",
                    mpa: 150,
                    type: "CODE_INPUT",
                    prompt: "Enter the single key shortcut that activates the **Shading Pie Menu** (Wireframe, Material Preview, Rendered).",
                    code: "// Quickly checking materials and shadows...",
                    answer: "Z",
                    feedback_incorrect: "The key is 'Z', which brings up the quick shading mode selection.",
                    mini_lesson: "Mini-Lesson: Pressing 'Z' is essential for quickly checking materials and lighting while modeling."
                }
            ]
        },
        
        // --- LEVEL 2: TRANSFORMATIONS (G, R, S and Axis Locking) ---
        {
            level: 2,
            title: "Level 2: Transformation & Axis Locking",
            recap: `FOCUS: Utilizing G, R, and S combined with axis keys (X, Y, Z) to achieve precise transformations.

Key Concepts:
- Pressing a transformation key twice uses local/global coordinates.
- Axis locking restricts movement to a single axis.`,
            questions: [
                {
                    id: "B2Q1",
                    attainment: "Low",
                    mpa: 100,
                    type: "CODE_INPUT",
                    prompt: "Which key activates the **Rotate** transformation tool?",
                    code: "// Spinning the object on its axis...",
                    answer: "R",
                    feedback_incorrect: "The shortcut is 'R', for Rotate.",
                    mini_lesson: "Mini-Lesson: G (Grab), R (Rotate), S (Scale)."
                },
                {
                    id: "B2Q2",
                    attainment: "Medium",
                    mpa: 150,
                    type: "DRAG_DROP_ORDER",
                    prompt: "Order the key sequence to **Rotate the selected object only around the Z-axis**.",
                    code: "// The sequence of keys pressed...",
                    answer_order: ["dd2_rotate", "dd2_z_axis"],
                    items: [
                        { id: "dd2_rotate", text: "R (Rotate)" },
                        { id: "dd2_z_axis", text: "Z (Axis Lock)" }
                    ],
                    feedback_incorrect: "Sequence: Tool (R) -> Axis (Z).",
                    mini_lesson: "Mini-Lesson: Tool + Axis locks the action to that coordinate."
                },
                {
                    id: "B2Q3",
                    attainment: "Medium",
                    mpa: 150,
                    type: "MCQ",
                    prompt: "What is the primary function of the **A** key in Object Mode?",
                    code: "// Selecting multiple objects...",
                    options: [
                        { text: "Deselects all or Selects all", isCorrect: true },
                        { text: "Activates the Annotation tool", isCorrect: false },
                        { text: "Toggles the Transform Gizmo", isCorrect: false },
                        { text: "Opens the Animation Editor", isCorrect: false }
                    ],
                    feedback_incorrect: "The 'A' key is used to quickly select everything or deselect everything.",
                    mini_lesson: "Mini-Lesson: Hit 'A' once to select all, hit it again to deselect all."
                },
                {
                    id: "B2Q4",
                    attainment: "High",
                    mpa: 200,
                    type: "CODE_INPUT",
                    prompt: "After pressing G, R, or S, what effect does pressing the **Middle Mouse Button (MMB)** have?",
                    code: "// Cancelling a transformation...",
                    answer: "Cancel the transformation",
                    feedback_incorrect: "Pressing MMB or Esc cancels the current transformation, reverting the object to its previous state.",
                    mini_lesson: "Mini-Lesson: MMB is a quick alternative to the Esc key for cancelling actions."
                }
            ]
        },

        // --- LEVEL 3: MODELING & WORKFLOW (Advanced Keys) ---
        {
            level: 3,
            title: "Level 3: Modeling & Workflow Keys",
            recap: `FOCUS: Essential keys for modeling tasks, rendering, and scene management.

Key Concepts:
- The 'E' key is fundamental for extrusion.
- Ctrl + R and Shift + D are powerful modeling/duplication tools.`,
            questions: [
                {
                    id: "B3Q1",
                    attainment: "Low",
                    mpa: 100,
                    type: "MCQ",
                    prompt: "What is the key shortcut used to perform the **Extrude** operation in Edit Mode?",
                    code: "// Pulling a face out...",
                    options: [
                        { text: "I (Insert Faces)", isCorrect: false },
                        { text: "E", isCorrect: true },
                        { text: "F (Make Face)", isCorrect: false },
                        { text: "G (Grab)", isCorrect: false }
                    ],
                    feedback_incorrect: "'E' is the core shortcut for Extrude.",
                    mini_lesson: "Mini-Lesson: 'E'xtrude is the most common modeling action."
                },
                {
                    id: "B3Q2",
                    attainment: "Medium",
                    mpa: 150,
                    type: "CODE_INPUT",
                    prompt: "Which key combination is used to **Duplicate** an object or selection (creating a new one without leaving the Move tool)?",
                    code: "// Creating an exact copy...",
                    answer: "Shift + D",
                    feedback_incorrect: "The shortcut is 'Shift + D' (Duplicate).",
                    mini_lesson: "Mini-Lesson: Shift + D is the quick way to create copies; Alt + D creates linked copies."
                },
                {
                    id: "B3Q3",
                    attainment: "High",
                    mpa: 200,
                    type: "DRAG_DROP_ORDER",
                    prompt: "Order the process to **Delete** the currently selected object.",
                    code: "// Removing an unnecessary object...",
                    answer_order: ["dd3_delete_key", "dd3_confirm"],
                    items: [
                        { id: "dd3_delete_key", text: "X (The Delete key in Blender)" },
                        { id: "dd3_confirm", text: "Click 'Delete' to confirm" }
                    ],
                    feedback_incorrect: "Sequence: Press 'X' (the shortcut for delete), then confirm the action.",
                    mini_lesson: "Mini-Lesson: Unlike many programs, 'X' is the primary delete key in Blender, not the Delete key itself."
                }
            ]
        }
    ];

    // --------------------------------------------------------------------------------
    // 2. GLOBAL STATE
    // --------------------------------------------------------------------------------
    let currentLevelIndex = 0;
    let currentQuestionIndex = -1; 
    let totalScore = 0;
    let currentQuestion = null;
    let currentMPA = 0; 
    let attempts = 0; 

    // --------------------------------------------------------------------------------
    // 3. CORE UI ELEMENTS
    // --------------------------------------------------------------------------------
    const els = {
        scoreDisplay: document.getElementById('score-display'),
        progressBar: document.getElementById('progress-bar'),
        progressText: document.getElementById('progress-text'),
        recapSection: document.getElementById('recap-section'),
        recapTitle: document.getElementById('recap-title'),
        recapContent: document.getElementById('recap-content'),
        questionArea: document.getElementById('question-area'),
        questionTitle: document.getElementById('question-title'),
        attainmentTag: document.getElementById('attainment-tag'),
        questionCodeSnippet: document.getElementById('question-code-snippet'),
        taskRenderer: document.getElementById('task-renderer'),
        submitBtn: document.getElementById('submit-btn'),
        feedbackModal: document.getElementById('feedback-modal'),
        modalTitle: document.getElementById('modal-title'),
        modalMessage: document.getElementById('modal-message'),
        modalCard: document.getElementById('modal-content-card'),
        modalMiniLesson: document.getElementById('modal-mini-lesson'),
        modalBtnText: document.getElementById('modal-btn-text'),
        modalCloseBtn: document.getElementById('modal-close-btn'), 
        gameOverArea: document.getElementById('game-over-area'),
        finalScore: document.getElementById('final-score')
    };

    // --------------------------------------------------------------------------------
    // 4. NAVIGATION & LIFE CYCLE
    // --------------------------------------------------------------------------------

    function initializeGame() {
        currentLevelIndex = 0;
        totalScore = 0;
        updateScoreDisplay();
        showRecapScreen();
    }

    function showRecapScreen() {
        const levelData = LESSON_DATA[currentLevelIndex];
        if (!levelData) {
            return showGameOverScreen();
        }

        els.questionArea.classList.add('hidden');
        els.recapSection.classList.remove('hidden');

        els.recapTitle.textContent = levelData.title;
        els.recapContent.textContent = levelData.recap.trim();
        
        currentQuestionIndex = -1;
        updateProgressDisplay();
    }

    function startLevel() {
        els.recapSection.classList.add('hidden');
        currentQuestionIndex = 0;
        loadQuestion(currentQuestionIndex);
    }

    function loadQuestion(index) {
        const levelData = LESSON_DATA[currentLevelIndex];
        if (!levelData || index >= levelData.questions.length) {
            currentLevelIndex++;
            return showRecapScreen();
        }

        currentQuestion = levelData.questions[index];
        currentMPA = currentQuestion.mpa;
        attempts = 0;
        currentQuestionIndex = index;
        
        // UI updates
        els.questionArea.classList.remove('hidden');
        els.questionTitle.textContent = `Q${index + 1}. ${currentQuestion.prompt}`;
        els.attainmentTag.textContent = currentQuestion.attainment.toUpperCase();
        els.attainmentTag.className = 'text-xs font-semibold px-2 py-1 rounded-full border border-gray-600';
        
        if (currentQuestion.attainment === 'Low') {
            els.attainmentTag.classList.add('text-green-300', 'border-green-700');
        } else if (currentQuestion.attainment === 'Medium') {
            els.attainmentTag.classList.add('text-yellow-300', 'border-yellow-700');
        } else if (currentQuestion.attainment === 'High') {
            els.attainmentTag.classList.add('text-red-300', 'border-red-700');
        }

        els.questionCodeSnippet.textContent = currentQuestion.code.trim();
        els.submitBtn.disabled = false;
        els.submitBtn.textContent = '[SUBMIT SOLUTION]';

        renderTask(currentQuestion);
        updateProgressDisplay();
    }

    function showGameOverScreen() {
        els.questionArea.classList.add('hidden');
        els.recapSection.classList.add('hidden');
        els.gameOverArea.classList.remove('hidden');
        els.finalScore.textContent = totalScore;
    }

    function updateScoreDisplay() {
        els.scoreDisplay.textContent = `SCORE: ${totalScore}`;
    }

    function updateProgressDisplay() {
        const levelData = LESSON_DATA[currentLevelIndex];
        if (!levelData) return;

        const totalQs = levelData.questions.length;
        const completedQs = currentQuestionIndex > -1 ? currentQuestionIndex : 0;
        
        els.progressText.textContent = `${levelData.title}: ${completedQs}/${totalQs} Completed`;
        
        const progressPercentage = (completedQs / totalQs) * 100;
        els.progressBar.style.width = `${progressPercentage}%`;
    }

    function applyPenalty() {
        const penaltyAmount = currentQuestion.mpa * 0.25; 
        const oldMPA = currentMPA;
        currentMPA -= penaltyAmount;
        currentMPA = Math.max(0, currentMPA); 

        const msg = `
        [[ ALERT: INCORRECT ATTEMPT ]]
        Penalty Applied: ${Math.round(penaltyAmount)} pts deducted from Max Potential Award.
        MPA reduced from ${oldMPA} to ${currentMPA}.
        `;
        showModal("Execution Error", msg, 'error');
    }

    function awardAndProceed(isCorrect) {
        const scoreAwarded = isCorrect ? Math.round(currentMPA) : 0;
        totalScore += scoreAwarded;
        updateScoreDisplay();

        let title, message, type, miniLesson = '';

        if (isCorrect) {
            title = "[[ SUCCESS: ANSWER ACCEPTED ]]";
            type = 'success';
            message = `
            Solution validated.
            Score Awarded: +${scoreAwarded} points.
            `;
            if (currentQuestion.type === 'CODE_INPUT') {
                message += `\nCorrect Shortcut:\n${currentQuestion.answer}`;
            }
            if (currentQuestion.type === 'DRAG_DROP_ORDER') {
                const solutionText = currentQuestion.answer_order.map(id => {
                    return currentQuestion.items.find(item => item.id === id).text;
                }).join(' -> ');
                message += `\nCorrect Sequence:\n${solutionText}`;
            }

        } else {
            title = "[[ FAILED: NO POINTS AWARDED ]]";
            type = 'error';
            message = `
            The attempt was incorrect.
            Score Awarded: 0 points.
            `;
            message += `\nReason: ${currentQuestion.feedback_incorrect}`;
            miniLesson = currentQuestion.mini_lesson;
        }

        showModal(title, message, type, miniLesson);

        document.getElementById('modal-close-btn').onclick = () => {
            closeModal();
            loadQuestion(currentQuestionIndex + 1);
        };
    }

    // --------------------------------------------------------------------------------
    // 6. TASK RENDERING & VALIDATION
    // --------------------------------------------------------------------------------

    function renderTask(q) {
        els.taskRenderer.innerHTML = '';
        const id = q.id;

        if (q.type === "MCQ") {
            q.options.forEach((option, i) => {
                const button = document.createElement('button');
                button.className = `mcq-option w-full text-left p-3 my-2 rounded-md hover:bg-gray-700 transition-colors border border-gray-600`;
                button.setAttribute('data-index', i);
                button.textContent = option.text;
                button.onclick = () => {
                    document.querySelectorAll('.mcq-option').forEach(btn => btn.classList.remove('bg-gray-600', 'border-cyan-500'));
                    button.classList.add('bg-gray-600', 'border-cyan-500');
                };
                els.taskRenderer.appendChild(button);
            });
        }
        else if (q.type === "CODE_INPUT") {
            const textarea = document.createElement('textarea');
            textarea.id = `${id}-input`;
            textarea.className = 'code-input w-full h-32 p-3 text-sm rounded-md resize-none';
            textarea.placeholder = '# Enter the key or key combination here (e.g., F3 or Shift + A)...';
            els.taskRenderer.appendChild(textarea);
        }
        else if (q.type === "DRAG_DROP_ORDER") {
            const sourceContainer = document.createElement('div');
            sourceContainer.id = `${id}-source`;
            sourceContainer.className = 'flex flex-wrap gap-3 p-3 bg-gray-700 rounded-md';
            
            const targetContainer = document.createElement('div');
            targetContainer.id = `${id}-target`;
            targetContainer.className = 'space-y-2 mt-4';

            const shuffledItems = shuffleArray([...q.items]);

            shuffledItems.forEach(item => {
                const dragItem = document.createElement('div');
                dragItem.id = item.id;
                dragItem.className = 'draggable-item p-3 rounded-md shadow-lg';
                dragItem.textContent = item.text;
                dragItem.draggable = true;
                dragItem.addEventListener('dragstart', handleDragStart);
                sourceContainer.appendChild(dragItem);
            });

            for (let i = 0; i < q.items.length; i++) {
                const target = document.createElement('div');
                target.className = 'drop-target p-2 rounded-md border-2 border-dashed border-gray-600 flex items-center';
                target.setAttribute('data-order', i);
                target.innerHTML = `<span class="mr-3 font-bold text-gray-500">${i + 1}.</span>`;
                target.addEventListener('dragover', handleDragOver);
                target.addEventListener('drop', handleDrop);
                targetContainer.appendChild(target);
            }

            els.taskRenderer.appendChild(sourceContainer);
            els.taskRenderer.appendChild(targetContainer);
        }
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function handleSubmit() {
        if (attempts > 0) return; 

        const input = getTaskInput(currentQuestion);

        if (input.isEmpty) {
            return showModal("Input Required", "[[ WARNING: NO INPUT PROVIDED ]]\nPlease enter your answer or make a selection before submitting.", 'info');
        }

        attempts++;
        
        let isCorrect = false;
        try {
            isCorrect = validateAnswer(currentQuestion, input.value);
        } catch (e) {
            console.error("Validation Error:", e);
            isCorrect = false;
        }

        if (isCorrect) {
            awardAndProceed(true);
        } else {
            applyPenalty();
            awardAndProceed(false);
        }
    }

    function getTaskInput(q) {
        const id = q.id;
        
        if (q.type === "MCQ") {
            const selectedBtn = document.querySelector('.mcq-option.bg-gray-600');
            const index = selectedBtn ? parseInt(selectedBtn.getAttribute('data-index')) : null;
            return { isEmpty: index === null, value: index };
        }
        else if (q.type === "CODE_INPUT") {
            const textarea = document.getElementById(`${id}-input`);
            const value = textarea ? textarea.value.trim() : '';
            return { isEmpty: value === '', value: value };
        }
        else if (q.type === "DRAG_DROP_ORDER") {
            const targetContainer = document.getElementById(`${id}-target`);
            const droppedItems = Array.from(targetContainer.children)
                .map(target => target.querySelector('.draggable-item')?.id)
                .filter(id => id); 
            
            return { isEmpty: droppedItems.length !== q.items.length, value: droppedItems };
        }

        return { isEmpty: true, value: null };
    }

    function validateAnswer(q, input) {
        if (q.type === "MCQ") {
            return q.options[input].isCorrect;
        }
        else if (q.type === "CODE_INPUT") {
            // Normalize input: trim, lowercase, remove spaces/symbols, allowing for variations like "shift+a" or "shift a"
            let normalizedInput = input.toLowerCase().replace(/[^a-z0-9+]/g, '');
            let normalizedAnswer = q.answer.toLowerCase().replace(/[^a-z0-9+]/g, '');

            // Special handling for multi-key shortcuts (like Shift + D)
            if (normalizedAnswer.includes('+')) {
                // Handle answers like "Shift D" -> "shiftd" and "Shift + D" -> "shift+d"
                const answerParts = normalizedAnswer.split('+').sort().join('');
                const inputParts = normalizedInput.split('+').sort().join('');

                // Check if the input contains the exact, normalized answer, OR if the sorted, cleaned parts match
                if (normalizedInput.includes(normalizedAnswer) || inputParts === answerParts.replace('+', '')) {
                     return true;
                }
                
                // Final check to handle simple single-key answers that might be phrased as 'Code Input'
                if (normalizedInput === normalizedAnswer) return true;

            }
            
            // For single-key answers (G, R, Z, etc.)
            return normalizedInput === normalizedAnswer.replace(/\s/g, '');
        }
        else if (q.type === "DRAG_DROP_ORDER") {
            if (!Array.isArray(input) || input.length !== q.answer_order.length) return false;
            return input.every((id, i) => id === q.answer_order[i]);
        }
        
        return false;
    }

    // --------------------------------------------------------------------------------
    // 7. DRAG AND DROP HANDLERS
    // --------------------------------------------------------------------------------
    let draggedItem = null;

    function handleDragStart(e) {
        draggedItem = e.target;
        e.dataTransfer.setData('text/plain', e.target.id);
        setTimeout(() => e.target.classList.add('opacity-50'), 0);
    }

    function handleDragOver(e) {
        e.preventDefault(); 
        e.target.closest('.drop-target').classList.add('bg-gray-600');
    }

    function handleDrop(e) {
        e.preventDefault();
        const target = e.target.closest('.drop-target');
        const data = e.dataTransfer.getData('text/plain');
        const item = document.getElementById(data);
        
        if (target && item) {
            const existingItem = target.querySelector('.draggable-item');
            if (existingItem) {
                document.getElementById(`${currentQuestion.id}-source`).appendChild(existingItem);
                existingItem.classList.remove('opacity-50');
            }
            target.appendChild(item);
            item.classList.remove('opacity-50');
        }
        target.classList.remove('bg-gray-600');
    }

    // --------------------------------------------------------------------------------
    // 8. MODAL/FEEDBACK SYSTEM
    // --------------------------------------------------------------------------------

    function showModal(title, message, type = 'info', miniLesson = '') {
        els.modalTitle.textContent = title;
        els.modalMessage.textContent = message;
        els.modalMiniLesson.textContent = miniLesson;
        
        els.modalCard.className = 'bg-gray-800 p-6 rounded-lg max-w-md w-full border-2';
        els.modalCloseBtn.className = 'w-full px-4 py-2 text-white rounded-md transition-colors font-semibold';
        els.modalMiniLesson.classList.add('hidden');
        els.modalMiniLesson.classList.remove('border-red-500', 'border-green-500');

        if (type === 'success') {
            els.modalCard.classList.add('border-green-500', 'glow-border');
            els.modalCloseBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            els.modalBtnText.textContent = 'Next Challenge'; 
        } else if (type === 'error') {
            els.modalCard.classList.add('border-red-500', 'glow-border');
            els.modalCloseBtn.classList.add('bg-red-600', 'hover:bg-red-500');
            els.modalBtnText.textContent = 'Next Challenge'; 
            if (miniLesson) {
                els.modalMiniLesson.classList.remove('hidden');
                els.modalMiniLesson.classList.add('border-red-500', 'text-red-300');
            }
        } else { 
            els.modalCard.classList.add('border-cyan-500');
            els.modalCloseBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-500');
            els.modalBtnText.textContent = 'Acknowledge';
            document.getElementById('modal-close-btn').onclick = closeModal;
        }

        els.feedbackModal.classList.remove('hidden');
    }

    function closeModal() {
        els.feedbackModal.classList.add('hidden');
    }

    window.onload = initializeGame;

</script>
</body>
</html>
